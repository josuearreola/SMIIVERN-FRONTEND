<div class="dashboard-layout">
    <!-- Overlay para cerrar menú móvil -->
    <div 
        class="mobile-menu-overlay" 
        [class.show]="showMobileMenu"
        (click)="closeMobileMenu()">
    </div>
    
    <header class="dashboard-header">
        <div class="header-left">
            <h1 class="app-title">SMIIVERN</h1>
        </div>

        <div class="header-center">
            <div *ngIf="puedeVerPerfilesActivos" class="profile-status" [class.clickable]="puedeVerPerfilesActivos"
                (click)="abrirGestionPerfiles()">
                <span class="profile-label">Perfil Activo:</span>
                <span class="profile-name" [class.sin-perfil]="!tienePerfilActivo">
                    {{nombrePerfilActivo}}
                </span>
                <i *ngIf="puedeCrearPerfilesActivos" class="bi bi-pencil-square profile-edit-icon"></i>
            </div>
        </div>

        <div class="header-right">
            <div class="last-update">
                <span class="update-label">Última actualización:</span>
                <span class="update-time">{{ currentTime }}</span>
            </div>

            <div class="theme-switch-container">
                <i class="bi bi-sun-fill theme-icon sun" [class.active]="!isDarkTheme"></i>
                <div class="theme-switch" (click)="toggleTheme()">
                    <div class="switch-slider" [class.dark]="isDarkTheme"></div>
                </div>
                <i class="bi bi-moon-fill theme-icon moon" [class.active]="isDarkTheme"></i>
            </div>
           

            <div class="hamburger-menu">
                <button class="hamburger-btn" (click)="toggleMobileMenu()">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <div class="mobile-menu-dropdown" [class.show]="showMobileMenu">
                    <!-- Toggle de tema solo para móvil -->
                    <div class="menu-item theme-toggle-mobile" (click)="toggleTheme()">
                        <i class="bi bi-palette"></i>
                        <span>Cambiar tema</span>
                        <div class="mobile-theme-switch">
                            <i class="bi bi-sun-fill" [class.active]="!isDarkTheme"></i>
                            <div class="mobile-switch">
                                <div class="mobile-switch-slider" [class.dark]="isDarkTheme"></div>
                            </div>
                            <i class="bi bi-moon-fill" [class.active]="isDarkTheme"></i>
                        </div>
                    </div>
                    <div class="menu-divider"></div>
                    <div *ngIf="puedeAccederConfiguracion" class="menu-item" (click)="navigateTo('settings'); closeMobileMenu()">
                        <i class="bi bi-gear"></i>
                        <span>Configuración</span>
                    </div>
                    <div class="menu-item" (click)="navigateTo('profile'); closeMobileMenu()">
                        <i class="bi bi-person"></i>
                        <span>Perfil</span>
                    </div>
                    <div class="menu-divider"></div>
                    <div class="menu-item logout" (click)="logout(); closeMobileMenu()">
                        <i class="bi bi-box-arrow-right"></i>
                        <span>Cerrar Sesión</span>
                    </div>
                </div>
            </div>
        </div>
    </header>


    <main class="dashboard-main">
        <div class="dashboard-content">
            <div class="left-column">
                
                <div class="alerts-section">
                    <div class="section-header">
                        <i class="bi bi-bell"></i>
                        <h3>Alertas Activas</h3>
                        <span class="alert-count" *ngIf="activeAlerts.length > 0">({{activeAlerts.length}})</span>
                    </div>
                    <div class="alerts-content">
                        <div *ngIf="activeAlerts.length === 0" class="no-alerts">
                            <i class="bi bi-check-circle-fill"></i>
                            <span>No hay alertas activas</span>
                        </div>
                        <div *ngFor="let alert of activeAlerts" class="alert-item" [ngClass]="alert.type">
                            <i class="bi" [ngClass]="{
                                                         'bi-exclamation-triangle-fill': alert.type === 'warning',
                                                         'bi-x-circle-fill': alert.type === 'error',
                                                         'bi-info-circle-fill': alert.type === 'info'
                                                       }"></i>
                            <span class="alert-label">{{alert.type === 'warning' ? 'Advertencia' : (alert.type === 'error' ? 'Error' :
                                'Info')}}</span>
                            <span class="alert-text">{{alert.message}}</span>
                            <small class="alert-time">{{alert.timestamp | date:'HH:mm:ss'}}</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="monitoring-section">
                    <div class="section-header">
                        <div class="header-left">
                            <i class="bi bi-activity"></i>
                            <h3>Monitoreo de sensores</h3>
                        </div>
                        <button class="history-link" [disabled]="generatingReport || !tienePerfilActivo" (click)="generateHistoryReport()"
                            [title]="!tienePerfilActivo ? 'Selecciona un perfil para generar reporte' : 'Generar reporte PDF'">
                            <i class="bi" [class.bi-clock-history]="!generatingReport" [class.bi-arrow-clockwise]="generatingReport"></i>
                            <span>{{ generatingReport ? 'Generando...' : 'Ver historial' }}</span>
                        </button>
                    </div>
                    <div class="sensors-content">
                        <!-- Estado sin perfil seleccionado -->
                        <div *ngIf="!tienePerfilActivo" class="no-profile-selected" (click)="abrirGestionPerfiles()">
                            <div class="no-profile-icon">
                                <i class="bi bi-flower1"></i>
                            </div>
                            <h4>Selecciona un perfil de planta</h4>
                            <p>Necesitas seleccionar un perfil de planta para ver el monitoreo de sensores</p>
                            <div class="select-profile-btn">
                                <i class="bi bi-plus-circle"></i>
                                <span>Seleccionar perfil</span>
                            </div>
                        </div>
                        
                        <!-- Estado con perfil seleccionado -->
                        <div *ngIf="tienePerfilActivo">
                            
                            
                            <!-- Datos de sensores en tiempo real -->
                            <div class="sensor-timestamp" *ngIf="latestSensorData">
                                <small>Última lectura: {{ latestSensorData.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}</small>
                            </div>
                        <div class="progress-sensors">
                            <div class="sensor-item">
                                <label>Temperatura</label>
                                <div class="progress-bar">
                                    <div class="progress-fill temperature" [style.width.%]="temperaturePercent"></div>
                                    <span class="progress-value">{{ temperatureValue }}°C</span>
                                </div>
                                <div class="progress-labels">
                                    <span>{{temperatureMin}}°C</span>
                                    <span>{{temperatureOptimal}}°C</span>
                                    <span>{{temperatureMax}}°C</span>
                                </div>
                            </div>

                            <div class="sensor-item">
                                <label>Humedad</label>
                                <div class="progress-bar">
                                    <div class="progress-fill humidity" [style.width.%]="humidityPercent"></div>
                                    <span class="progress-value">{{ humidityValue }}%</span>
                                </div>
                                <div class="progress-labels">
                                    <span>0%</span>
                                    <span>{{humidityOptimal}}% (óptimo)</span>
                                    <span>100%</span>
                                </div>
                            </div>
                            <div class="sensor-item">
                                <label>pH del Suelo</label>
                                <div class="progress-bar">
                                    <div class="progress-fill ph" [style.width.%]="phPercent"></div>
                                    <span class="progress-value">{{ phValue }}</span>
                                </div>
                                <div class="progress-labels">
                                    <span>{{phMin}}</span>
                                    <span>{{phOptimal}}</span>
                                    <span>{{phMax}}</span>
                                </div>
                            </div>
                        </div>
                        <div class="nutrients-section">
                            <div class="nutrients-header">
                                <i class="bi bi-circle"></i>
                                <h4>Nutrientes (NPK)</h4>
                            </div>
                            <div class="nutrients-gauges">
                                <div class="gauge-item">
                                    <div class="gauge-circle">
                                        <div class="gauge-fill nitrogen"
                                            [style.background]="getGaugeBackground(nitrogenValue)"></div>
                                        <div class="gauge-value">{{ nitrogenValue }}%</div>
                                    </div>
                                    <label>Nitrógeno (N)</label>
                                    <div class="gauge-raw-value">{{ nitrogenRawValue }} mg/kg</div>
                                </div>

                                <div class="gauge-item">
                                    <div class="gauge-circle">
                                        <div class="gauge-fill phosphorus"
                                            [style.background]="getGaugeBackground(phosphorusValue)"></div>
                                        <div class="gauge-value">{{ phosphorusValue }}%</div>
                                    </div>
                                    <label>Fósforo (P)</label>
                                    <div class="gauge-raw-value">{{ phosphorusRawValue }} mg/kg</div>
                                </div>

                                <div class="gauge-item">
                                    <div class="gauge-circle">
                                        <div class="gauge-fill potassium"
                                            [style.background]="getGaugeBackground(potassiumValue)"></div>
                                        <div class="gauge-value">{{ potassiumValue }}%</div>
                                    </div>
                                    <label>Potasio (K)</label>
                                    <div class="gauge-raw-value">{{ potassiumRawValue }} mg/kg</div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<!-- Componente de Alertas Globales -->
<app-alert-modal></app-alert-modal>

<!-- Componente Modal de Perfiles -->
<app-modal-perfiles [show]="showPerfilesModal" (cerrarModal)="cerrarModalPerfiles()"
    (perfilSeleccionado)="onPerfilSeleccionado($event)">
</app-modal-perfiles>
<!-- Modal de Configuración -->
<app-configuracion-modal *ngIf="showConfiguracionModal" (closeModal)="closeConfiguracionModal()">
</app-configuracion-modal>
<!-- Alert Modal Personalizada -->
<app-alert-modal [show]="(alerts$ | async) !== null"
    [data]="(alerts$ | async) || { title: '', message: '', type: 'info' }" (confirm)="alertService.close()"
    (cancel)="alertService.close()" (close)="alertService.close()">
</app-alert-modal>